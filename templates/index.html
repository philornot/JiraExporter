<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jira Exporter</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
<div class="container">
    <h1>Jira Exporter</h1>

    <div id="auth-section">
        <h2>Authentication</h2>
        <p>Credentials are loaded from environment variables.</p>
        <button id="auth-btn" onclick="authenticate()">Connect to Jira</button>
        <div id="auth-status"></div>
    </div>

    <div id="projects-section" style="display: none;">
        <h2>Select Project</h2>
        <div id="projects-loading">Loading projects…</div>
        <select id="project-select" style="display: none;">
            <option value="">-- Select a project --</option>
        </select>
        <p class="help-text">
            Exports all issues from the selected project as a Markdown (.md) file —
            one section per issue, including status, parent, and description.
        </p>

        <div id="stats-section"></div>
        <div id="range-section" style="display: none;"></div>

        <button id="export-btn" onclick="exportProject()" style="display: none;">
            Export to Markdown
        </button>
        <div id="export-status"></div>
    </div>

    <div id="progress-section" style="display: none;">
        <h2>Export Progress</h2>
        <div class="progress-bar">
            <div id="progress-fill"></div>
        </div>
        <p id="progress-text">Preparing export…</p>
    </div>

    <div id="debug-section"
         style="margin-top:30px;padding:15px;background:#f9f9f9;border-radius:4px;display:none;">
        <h3 style="margin-top:0;font-size:16px;color:#666;">Configuration Debug</h3>
        <pre id="debug-info" style="font-size:12px;color:#666;margin:0;"></pre>
    </div>
</div>

<script src="{{ url_for('static', filename='script.js') }}"></script>
<script>
    // Load config on page load — propagate threshold to script.js global,
    // and show the debug panel when any env variable is missing.
    fetch('/api/config')
        .then(function (r) {
            return r.json();
        })
        .then(function (data) {
            // largeProjectThreshold is declared in script.js; update it here
            // once we know the server-side value.
            if (typeof data.large_project_threshold === 'number') {
                largeProjectThreshold = data.large_project_threshold;
            }

            var debugSection = document.getElementById('debug-section');
            var debugInfo = document.getElementById('debug-info');
            var emailLabel = data.email_set ? '✓ ' + (data.email || 'set') : '✗ missing';
            var tokenLabel = data.token_set ? '✓ set (' + data.token_length + ' chars)' : '✗ missing';
            var domainLabel = data.domain_set ? '✓ ' + (data.domain || 'set') : '✗ missing';

            debugInfo.textContent =
                'Email:  ' + emailLabel + '\n' +
                'Token:  ' + tokenLabel + '\n' +
                'Domain: ' + domainLabel;

            if (!data.email_set || !data.token_set || !data.domain_set) {
                debugSection.style.display = 'block';
            }
        })
        .catch(function (err) {
            console.error('Failed to load config:', err);
        });
</script>
</body>
</html>